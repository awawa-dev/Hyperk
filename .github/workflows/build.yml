name: PlatformIO Build All

on:
  push:
  workflow_dispatch:

jobs:
  build:
    name: "${{ matrix.group }}"
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        include:
          - group: ModernESP_C2_C6
            boards: "esp32c2 esp32c6"
          - group: ModernESP_C3_C5
            boards: "esp32c3 esp32c5"
          - group: ModernESP_S3
            boards: "esp32s3"
          - group: ClassicESP
            boards: "esp32 esp32s2 esp32-eth01 esp8266"
          - group: Pico
            boards: "pico pico2"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: "Cache PlatformIO - ${{ matrix.group }}"
        uses: actions/cache@v5
        with:
          path: |
            ~/.platformio/packages
            ~/.platformio/platforms
          key: pio-${{ matrix.group }}-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            pio-${{ matrix.group }}-

      - name: Install PlatformIO + esptool
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade platformio esptool

      - name: Build ${{ matrix.group }}
        run: |
          ENVS="${{ matrix.boards }}"
          CMD="pio run -j 2"
          for env in $ENVS; do
            CMD="$CMD -e $env"
          done
          eval "$CMD" || (sleep 25 && echo "ðŸ”„ Retry for ${{ matrix.group }} (network?)" && eval "$CMD")

      - name: "Upload Artifacts - ${{ matrix.group }}"
        uses: actions/upload-artifact@v7
        with:
          name: Hyperk-Firmware-${{ matrix.group }}
          path: release/
          if-no-files-found: error

      - name: Generate Job Summary
        run: |
          echo "**Boards:** ${{ matrix.boards }}" >> $GITHUB_STEP_SUMMARY

  release:
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v8
        with:
          pattern: Hyperk-Firmware-*
          path: release
          merge-multiple: true

      - name: Create Pre-release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}