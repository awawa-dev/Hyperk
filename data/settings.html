<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Settings - Hyperk</title>
  <link rel="stylesheet" href="/css/pico.min.css?v={{VERSION}}">
  <link rel="stylesheet" href="/css/style.css?v={{VERSION}}">
  <link rel="stylesheet" href="/css/settings.css?v={{VERSION}}">
  <link id="favicon" rel="icon" type="image/png" href="/img/hyperk.png?v={{VERSION}}">
</head>
<body>

  <nav class="container-fluid">
    <ul>
      <li style="display: flex; align-items: center;">
        <span class="logo-h"></span><strong class="yperk">y<span class="perk">perk</span></strong>
      </li>
    </ul>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/settings.html">Settings</a></li>
      <li><a href="/stats.html">Stats</a></li>
    </ul>
  </nav>

  <main class="container">
    <h1>Settings</h1>

    <!-- WiFi settings -->
    <form action="/save_wifi" method="POST">
      <details id="wifi_configuration_page" style="display: none;">
        <summary role="button" class="outline secondary">WiFi Configuration</summary>
        <div>
          <label for="ssid_select">SSID:</label>
          <select name="ssid" id="ssid_select" required>
            <option value="">Scanning...</option>
          </select>
          <div id="custom_ssid_wrapper" style="display:none; margin-top:8px;">
            <label for="ssid_custom">Custom SSID:</label>
            <input type="text" name="ssid_custom" id="ssid_custom" placeholder="Enter custom SSID">
          </div>
          <label>Password <input type="password" name="pass" required></label>
          <button type="submit">Save WiFi & Restart</button>
        </div>
      </details>
    </form>

    <!-- Settings -->
    <form action="/save_config" method="POST">
      <details>
        <summary role="button" class="outline secondary">LED Hardware</summary>
        <div>
          <label>LED type
            <select id="ledType" name="type" required>
              <option value="0">WS2812B NeoPixel (RGB)</option>
              <option value="1">SK6812 NeoPixel (RGBW)</option>
              <option value="2">APA102 DotStar SPI (RGB)</option>
            </select>
          </label>

          <label>Data Pin (GPIO)
            <select type="number" name="dataPin" required></select>
          </label>

          <label id="clockPinLabel">Clock Pin (GPIO)
            <select type="number" name="clockPin"></select>
          </label>

          <label>Number of LEDs
            <input type="number" name="numLeds" min="1" max="2000" value="16" required>
          </label>          
        
          <div id="whiteCalibration" style="display: none;">
            <hr class="section-divider">
            <h5>White channel calibration</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">            
              <label>R <input type="number" name="calRed" min="0" max="255" value="160"></label>
              <label>G <input type="number" name="calGreen" min="0" max="255" value="160"></label>
              <label>B <input type="number" name="calBlue" min="0" max="255" value="160"></label>
              <label>White <input type="number" name="calGain" min="0" max="255" value="255"></label>
              <button type="button" onclick="setCalibration(255, 160, 160, 160)">Set Cold</button>
              <button type="button" onclick="setCalibration(255, 176, 176, 112)">Set Neutral</button>
            </div>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" class="outline secondary">Light Preset</summary>
        <div>
          <label>Brightness (1‚Äì255)
            <input type="number" name="brightness" min="1" max="255" value="255" oninput="this.nextElementSibling.value=this.value"><input type="range" min="1" max="255" value="255" oninput="this.previousElementSibling.value=this.value">
          </label>

          <label>Default Color
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <label>R <input type="number" name="r" min="0" max="255" value="196" oninput="this.nextElementSibling.value=this.value"><input type="range" min="0" max="255" value="196" oninput="this.previousElementSibling.value=this.value"></label>
              <label>G <input type="number" name="g" min="0" max="255" value="32" oninput="this.nextElementSibling.value=this.value"><input type="range" min="0" max="255" value="32" oninput="this.previousElementSibling.value=this.value"></label>
              <label>B <input type="number" name="b" min="0" max="255" value="8" oninput="this.nextElementSibling.value=this.value"><input type="range" min="0" max="255" value="8" oninput="this.previousElementSibling.value=this.value"></label>
            </div>
          </label>

          <label>Default Effect
            <select name="effect">
              <option value="0">Solid Color</option>
              <option value="1">Rainbow</option>
            </select>
          </label>
        </div>
      </details>

      <details>
        <summary role="button" class="outline secondary">Network</summary>
        <div>
          <label>Extra MDNS tag
            <input type="text" name="extraMdnsTag" maxlength="15">
          </label>
        </div>
      </details>

      <details id="ota_page" style="display: none;" ontoggle="loadSubScript(this, 'ota', null)">
        <summary role="button" class="outline secondary">Firmware Update (OTA)</summary>
        <div>
          <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--pico-form-element-border-color); border-radius: var(--pico-border-radius); text-align: center; background: rgba(128, 128, 128, 0.05);">
            <small style="display: block; color: var(--pico-muted-color); margin-bottom: 0.25rem;">Current Firmware</small>
            <strong style="font-size: 1.25rem;" id="firmware_version_info">‚Äî</strong>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label for="ota_channel" style="margin-bottom: 0.5rem; display: block;">Update Channel</label>
            <div style="display: flex; gap: 0.5rem;">
              <select id="ota_channel" style="margin-bottom: 0; flex: 1;">
                <option value="stable">Stable</option>
                <option value="testing">Testing</option>
              </select>
              <button type="button" id="check_update_btn" class="secondary outline"
                      style="margin-bottom: 0; white-space: nowrap; width: auto; background-color: #2e7d32; border-color: #2e7d32; color: #fff;"
                      onclick="checkFirmwareUpdates()">
                Check
              </button>
            </div>
          </div>
          
          <div id="ota_status_area" style="display: none; margin-top: 1.5rem; padding: 1.5rem 1rem; background: var(--card-sectionning-background-color); border: 1px solid #eab308; border-radius: var(--border-radius); text-align: center;">
            <p id="ota_status_text" style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: bold;">Checking...</p>
            <progress id="ota_progress" value="0" max="100" style="display: none;"></progress>
            
            <button type="button" id="install_update_btn" style="display: none; margin-top: 0.5rem; background-color: #eab308; border-color: #eab308; color: #111; font-weight: bold; width: 100%;" onclick="startOtaUpdate()">
              Install Update
            </button>
          </div>
        </div>
      </details>

      <button type="submit">Save Settings</button>
    </form>
  </main>
  <article id="toast">
    <header>
      <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
        <span id="toast-title">üíæ Configuration saved</span>
        <span style="cursor:pointer; opacity:0.7;" onclick="document.getElementById('toast').classList.remove('show')">‚úï</span>
      </div>
    </header>
    <div class="toast-body">
      <span class="check-icon" id="toast-icon">‚úî</span>
      <span id="toast-msg">Your configuration has been saved successfully.</span>
    </div>
  </article>
  <dialog id="confirm-modal">
    <article>
      <h3>‚ö†Ô∏è OTA Firmware Flash Procedure</h3>
      <p id="confirm-msg">Are you sure you want to change version?</p>
      <footer>
        <button class="secondary outline" onclick="closeConfirm(false)">Cancel</button>
        <button class="contrast" onclick="closeConfirm(true)">Yes, proceed</button>
      </footer>
    </article>
  </dialog>
  <script>
      let scanInterval = 3500;
      let cfgDeviceArchitecture = "";
      let cfgBoardArchitecture = ""
      let cfgDeviceVersion = "";

      const loadedScripts = {};
      function loadSubScript(el, scriptName, initFunName) {
          if (el.open && !loadedScripts[scriptName]) {
              console.log(`Loading module: ${scriptName}`);
              
              const script = document.createElement('script');
              script.src = `/${scriptName}.js?v={{VERSION}}`;
              
              script.onload = () => {
                  loadedScripts[scriptName] = true;
                  console.log(`‚úÖ Loaded: ${scriptName} module`);
                  if (initFunName && typeof window[initFunName] === 'function') {
                      window[initFunName]();
                  }
              };

              script.onerror = () => {
                  console.error(`‚ùå Failed to load: ${scriptName}`);
              };

              document.head.appendChild(script);
          }
      }

      function setupPinValidator() {
          const hardwareLimits = {
              "ESP32-C6": { gpio: [0,1,2,3,4,5,6,7,8,10,15,18,19,20,21,22], spi: {6:5} },
              "ESP32-S3": { gpio: [1,2,4,5,6,7,8,10,16,17,18,48], spi: {11:12} },
              "ESP32-C3": { gpio: [0,1,2,3,4,5,6,7,8,10,20,21], spi: {7:6} },
              "ESP8266":  { gpio: [2],                       spi: {19:18} },
              "ESP32":    { gpio: null,                      spi: {23:18} },
              "ESP32-S2": { gpio: null,                      spi: {19:18} }
          };
          
          const arch = (typeof cfgDeviceArchitecture !== 'undefined') ? cfgDeviceArchitecture : "";
          const els = { type: document.getElementById('ledType'), clkLabel: document.getElementById('clockPinLabel') };

          if (!els.type || !els.clkLabel) {
              console.warn("LED Validator: Missing required DOM elements (ledType/clockPinLabel)");
              return;
          }

          els.clkLabel.setAttribute('aria-live', 'polite');

          const setField = (name, opts) => {
              const old = document.getElementsByName(name)[0];
              if (!old) return null;
              
              const isSel = (opts != null);
              const signature = "sig_" + JSON.stringify(opts);

              if ((old.tagName === 'SELECT') === isSel && old.dataset.sig === signature) return old;

              const wasFocused = (document.activeElement === old);

              const el = isSel ? document.createElement('select') : Object.assign(document.createElement('input'), {
                  type: 'number', min: 0, max: (arch.includes('8266') ? 16 : 48), step: '1'
              });
              
              el.name = name; el.id = old.id; el.required = true;
              el.dataset.sig = signature;

              if (isSel) {
                  opts.forEach(p => el.add(new Option(`GPIO ${p}`, p)));
                  el.value = opts.includes(parseInt(old.value)) ? old.value : opts[0];

                  if (opts.length === 1) { 
                      el.disabled = true;
                      el.title = "Only one valid GPIO for this mode/architecture"; 
                  }
              } else {
                  el.value = old.value || 0;
              }

              old.replaceWith(el);
              el.addEventListener('change', updateUI); 
              
              if (wasFocused) el.focus();
              return el;
          };

          function updateUI() {
              const isSpi = els.type.value == "2";
              const cfg = hardwareLimits[arch];

              let validPins = cfg ? (isSpi ? Object.keys(cfg.spi).map(Number) : cfg.gpio) : null;
              const dataPinEditor = setField('dataPin', validPins);
              
              const autoClk = (cfg && cfg.spi) ? (cfg.spi[dataPinEditor.value] ?? null) : null;
              const clockPinEditor = setField('clockPin', ((autoClk !== null) ? [autoClk] : null)); 

              els.clkLabel.style.display = isSpi ? 'block' : 'none';
              clockPinEditor.disabled = clockPinEditor.disabled || !isSpi;
          }

          els.type.onchange = updateUI;
          updateUI(); 
      }

      function setCalibration(gain, r, g, b) {
          const fields = { 'calGain': gain, 'calRed': r, 'calGreen': g, 'calBlue': b };

          for (const [name, value] of Object.entries(fields)) {
              const el = document.querySelector(`input[name="${name}"]`);
              if (el) {
                  el.value = value;                  
              }
          }
      }

      function toggleCalibration() {
          const ledTypeSelect = document.getElementById('ledType');
          const calSection = document.getElementById('whiteCalibration');
          
          calSection.style.display = (ledTypeSelect.value === "1") ? "block" : "none";
      }

      function showToast(isReboot) {
          const t = document.getElementById('toast');
          const title = document.getElementById('toast-title');
          const msg = document.getElementById('toast-msg');
          const icon = document.getElementById('toast-icon');

          if (isReboot) {
              title.innerHTML = "üîÑ Rebooting...";
              icon.innerHTML = "‚è≥";
              msg.innerHTML = 'Device is restarting to apply changes...';
              setTimeout(() => { location.reload(); }, 10000);
          } else {
              title.innerHTML = "üíæ Saved";
              icon.innerHTML = "‚úî";
              msg.innerHTML = "Configuration updated!";
          }

          t.classList.add('show');
          setTimeout(() => { t.classList.remove('show'); }, isReboot ? 10000 : 3000);
      }

      async function loadCurrentConfig() {
          try {
              const res = await fetch('/api/get_current_config');
              if (!res.ok) return;
              const c = await res.json();
              const l = c.config;

              const archField = l["architecture"];              
              if (archField !== undefined){
                  cfgDeviceArchitecture = archField;                  
              }
              
              const boardField = l["board"];              
              if (boardField !== undefined){
                  cfgBoardArchitecture = boardField;                  
              }
              
              const versionField = l["version"];              
              if (versionField !== undefined){
                  cfgDeviceVersion = versionField;                  
              }
              
              const fwInfo = document.getElementById('firmware_version_info');
              if (fwInfo) {
                  fwInfo.innerHTML = `<strong>${cfgDeviceVersion || 'unknown'}</strong> <small style="opacity:0.75">(${cfgDeviceArchitecture || '‚Äî'})</small>`;
              }

              const fields = ['type', 'dataPin', 'clockPin', 'numLeds', 'brightness', 'r', 'g', 'b', 'effect', 'extraMdnsTag', 'calGain', 'calRed', 'calGreen', 'calBlue'];
              fields.forEach(field => {
                  const el = document.querySelector(`[name="${field}"]`);
                  if (el && l[field] !== undefined){
                    if (field == 'dataPin' || field == 'clockPin')
                    {
                        el.add(new Option(`GPIO ${l[field]}`, l[field]));
                    }
                    el.value = l[field];
                    el.dispatchEvent(new Event('input'));
                  }
              });

              if (l["apMode"] === true) {
                  document.getElementById("wifi_configuration_page").style.display = "block";
                  loadSubScript(this, 'wifi', "scanWifi");
              } else {
                  document.getElementById("ota_page").style.display = "block";           
              }

              toggleCalibration();
              setupPinValidator();
          }
          catch (e) {
              console.error("Config load failed:", e);
          }
      }

      document.addEventListener('DOMContentLoaded', () => {
          const select = document.getElementById('ssid_select');
          const customDiv = document.getElementById('custom_ssid_wrapper');
          const customInput = document.getElementById('ssid_custom');
          const ledTypeSelect = document.getElementById('ledType');

          select.addEventListener('change', () => {
              if (select.value === 'CUSTOM') {
                  customDiv.style.display = 'block';
                  setTimeout(() => customInput.focus(), 100);
                  customInput.required = true;
              }
              else {
                  customDiv.style.display = 'none';
                  customInput.required = false;
                  customInput.value = '';
              }
          });

          ledTypeSelect.addEventListener('change', toggleCalibration);
          
          loadCurrentConfig();
      });

      document.querySelector('form[action="/save_config"]').addEventListener('submit', async (e) => {
          e.preventDefault();
          const f = e.target, btn = f.querySelector('button');
          btn.setAttribute('aria-busy', 'true');

          try {
              const res = await fetch(f.action, { method: 'POST', body: new URLSearchParams(new FormData(f)) });
              if (res.ok) {
                  const data = await res.json();
                  showToast(data.status === 'reboot');
              }
          } catch (err) { alert("Error!"); }
          
          btn.setAttribute('aria-busy', 'false');
      });
</script>
</body>
</html>