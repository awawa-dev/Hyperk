<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Settings - Hyperk</title>
  <link rel="stylesheet" href="/css/pico.min.css?v={{VERSION}}">
  <link rel="stylesheet" href="/css/style.css?v={{VERSION}}">
  <link rel="stylesheet" href="/css/settings.css?v={{VERSION}}">
  <link id="favicon" rel="icon" type="image/png" href="/img/hyperk.png?v={{VERSION}}">
</head>
<body>

  <nav class="container-fluid">
    <ul>
      <li style="display: flex; align-items: center;">
        <span class="logo-h"></span><strong class="yperk">y<span class="perk">perk</span></strong>
      </li>
    </ul>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/settings.html">Settings</a></li>
      <li><a href="/stats.html">Stats</a></li>
    </ul>
  </nav>

  <main class="container">
    <h1>Settings</h1>

    <!-- WiFi settings -->
    <form action="/save_wifi" method="POST">
      <details id="wifi_configuration_page" style="display: none;">
        <summary role="button" class="outline secondary">WiFi Configuration</summary>
        <div>
          <label for="ssid_select">SSID:</label>
          <select name="ssid" id="ssid_select" required>
            <option value="">Scanning...</option>
          </select>
          <div id="custom_ssid_wrapper" style="display:none; margin-top:8px;">
            <label for="ssid_custom">Custom SSID:</label>
            <input type="text" name="ssid_custom" id="ssid_custom" placeholder="Enter custom SSID">
          </div>
          <label>Password <input type="password" name="pass" required></label>
          <button type="submit">Save WiFi & Restart</button>
        </div>
      </details>
    </form>

    <!-- Settings -->
    <form action="/save_config" method="POST">
      <details ontoggle="loadSubScript('gpio', 'setupPinValidator');loadSubScript('calibration', 'setupCalibration');">
        <summary role="button" class="outline secondary">LED Hardware</summary>
        <div>
          <label>LED type
            <select id="ledType" name="type" required>
              <option value="0">WS2812B NeoPixel (RGB)</option>
              <option value="1">SK6812 NeoPixel (RGBW)</option>
              <option value="2">APA102 DotStar SPI (RGB)</option>
            </select>
          </label>

          <label>Data Pin (GPIO)
            <select name="dataPin" required></select>
          </label>

          <label id="clockPinLabel">Clock Pin (GPIO)
            <select name="clockPin"></select>
          </label>

          <label>Number of LEDs
            <input type="number" name="numLeds" min="1" max="2000" value="16" required>
          </label>          
        
          <div id="whiteCalibration" style="display: none;">
            <hr class="section-divider">
            <h5>White channel calibration</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">            
              <label>R <input type="number" name="calRed" min="0" max="255" value="160"></label>
              <label>G <input type="number" name="calGreen" min="0" max="255" value="160"></label>
              <label>B <input type="number" name="calBlue" min="0" max="255" value="160"></label>
              <label>White <input type="number" name="calGain" min="0" max="255" value="255"></label>
              <button type="button" id="cal-cold">Set Cold</button>
              <button type="button" id="cal-neutral">Set Neutral</button>
            </div>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" class="outline secondary">Light Preset</summary>
        <div>
          <label>Brightness (1‚Äì255)
            <input type="number" name="brightness" min="1" max="255" value="255" oninput="this.nextElementSibling.value=this.value"><input type="range" min="1" max="255" value="255" oninput="this.previousElementSibling.value=this.value">
          </label>

          <label>Default Color
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <label>R <input type="number" name="r" min="0" max="255" value="196" oninput="this.nextElementSibling.value=this.value"><input type="range" min="0" max="255" value="196" oninput="this.previousElementSibling.value=this.value"></label>
              <label>G <input type="number" name="g" min="0" max="255" value="32" oninput="this.nextElementSibling.value=this.value"><input type="range" min="0" max="255" value="32" oninput="this.previousElementSibling.value=this.value"></label>
              <label>B <input type="number" name="b" min="0" max="255" value="8" oninput="this.nextElementSibling.value=this.value"><input type="range" min="0" max="255" value="8" oninput="this.previousElementSibling.value=this.value"></label>
            </div>
          </label>

          <label>Default Effect
            <select name="effect">
              <option value="0">Solid Color</option>
              <option value="1">Rainbow</option>
            </select>
          </label>
        </div>
      </details>

      <details>
        <summary role="button" class="outline secondary">Network</summary>
        <div>
          <label>Device Name (MDNS)
            <input type="text" name="deviceName" maxlength="15">
          </label>
        </div>        
        <div>
          <label>Extra MDNS tag
            <input type="text" name="extraMdnsTag" maxlength="15">
          </label>
        </div>
      </details>

      <details id="ota_page" style="display: none;" ontoggle="loadSubScript('ota', null)">
        <summary role="button" class="outline secondary">Firmware Update (OTA)</summary>
        <div>
          <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--pico-form-element-border-color); border-radius: var(--pico-border-radius); text-align: center; background: rgba(128, 128, 128, 0.05);">
            <small style="display: block; color: var(--pico-muted-color); margin-bottom: 0.25rem;">Current Firmware</small>
            <strong style="font-size: 1.25rem;" id="firmware_version_info">‚Äî</strong>
          </div>

          <div style="margin-bottom: 1.5rem;">
            <label for="ota_channel" style="margin-bottom: 0.5rem; display: block;">Update Channel</label>
            <div style="display: flex; gap: 0.5rem;">
              <select id="ota_channel" style="margin-bottom: 0; flex: 1;">
                <option value="stable">Stable</option>
                <option value="testing">Testing</option>
              </select>
              <button type="button" id="check_update_btn" class="secondary outline"
                      style="margin-bottom: 0; white-space: nowrap; width: auto; background-color: #2e7d32; border-color: #2e7d32; color: #fff;"
                      onclick="checkFirmwareUpdates()">
                Check
              </button>
            </div>
          </div>
          
          <div id="ota_status_area" style="display: none; margin-top: 1.5rem; padding: 1.5rem 1rem; background: var(--card-sectionning-background-color); border: 1px solid #eab308; border-radius: var(--border-radius); text-align: center;">
            <p id="ota_status_text" style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: bold;">Checking...</p>
            <progress id="ota_progress" value="0" max="100" style="display: none;"></progress>
            
            <button type="button" id="install_update_btn" style="display: none; margin-top: 0.5rem; background-color: #eab308; border-color: #eab308; color: #111; font-weight: bold; width: 100%;" onclick="startOtaUpdate()">
              Install Update
            </button>
          </div>

          <div class="ota-footer">
            <a href="https://awawa-dev.github.io/hyperk/privacy.html" target="_blank">Privacy Policy</a>
          </div>
        </div>
      </details>

      <button type="submit">Save Settings</button>
    </form>
  </main>
  <article id="toast" style="visibility: hidden;">
    <header>
      <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
        <span id="toast-title">üíæ Configuration saved</span>
        <span style="cursor:pointer; opacity:0.7;" onclick="document.getElementById('toast').classList.remove('show')">‚úï</span>
      </div>
    </header>
    <div class="toast-body">
      <span class="check-icon" id="toast-icon">‚úî</span>
      <span id="toast-msg">Your configuration has been saved successfully.</span>
    </div>
  </article>
  <dialog id="confirm-modal">
    <article>
      <h3>‚ö†Ô∏è OTA Firmware Flash Procedure</h3>
      <p id="confirm-msg">Are you sure you want to change version?</p>
      <footer>
        <button class="secondary outline" onclick="closeConfirm(false)">Cancel</button>
        <button class="contrast" onclick="closeConfirm(true)">Yes, proceed</button>
      </footer>
    </article>
  </dialog>
  <script>
      let scanInterval = 3500;
      let cfgDeviceArchitecture = "";
      let cfgBoardArchitecture = ""
      let cfgDeviceVersion = "";

      const loadedScripts = {};
      function loadSubScript(scriptName, initFunName) {
          if (!loadedScripts[scriptName]) {
              console.log(`Loading module: ${scriptName}`);
              
              const script = document.createElement('script');
              script.src = `/${scriptName}.js?v={{VERSION}}`;
              
              script.onload = () => {
                  loadedScripts[scriptName] = true;
                  console.log(`‚úÖ Loaded: ${scriptName} module`);
                  if (initFunName && typeof window[initFunName] === 'function') {
                      window[initFunName]();
                  }
              };

              script.onerror = () => {
                  console.error(`‚ùå Failed to load: ${scriptName}`);
              };

              document.head.appendChild(script);
          }
      }

      function showToast(isReboot) {
          const t = document.getElementById('toast');
          const title = document.getElementById('toast-title');
          const msg = document.getElementById('toast-msg');
          const icon = document.getElementById('toast-icon');

          if (isReboot) {
              title.innerHTML = "üîÑ Rebooting...";
              icon.innerHTML = "‚è≥";
              msg.innerHTML = 'Device is restarting to apply changes...';
              setTimeout(() => { location.reload(); }, 10000);
          } else {
              title.innerHTML = "üíæ Saved";
              icon.innerHTML = "‚úî";
              msg.innerHTML = "Configuration updated!";
          }

          t.classList.add('show');
          setTimeout(() => { t.classList.remove('show'); }, isReboot ? 10000 : 3000);
      }

      async function loadCurrentConfig() {
          try {
              const res = await fetch('/api/get_current_config');
              if (!res.ok) return;
              const c = await res.json();
              const l = c.config;

              const archField = l["architecture"];              
              if (archField !== undefined){
                  cfgDeviceArchitecture = archField;                  
              }
              
              const boardField = l["board"];              
              if (boardField !== undefined){
                  cfgBoardArchitecture = boardField;                  
              }
              
              const versionField = l["version"];              
              if (versionField !== undefined){
                  cfgDeviceVersion = versionField;                  
              }
              
              const fwInfo = document.getElementById('firmware_version_info');
              if (fwInfo) {
                  fwInfo.innerHTML = `<strong>${cfgDeviceVersion || 'unknown'}</strong> <small style="opacity:0.75">(${cfgDeviceArchitecture || '‚Äî'})</small>`;
              }

              const fields = ['type', 'dataPin', 'clockPin', 'numLeds', 'brightness', 'r', 'g', 'b', 'effect', 'deviceName', 'extraMdnsTag', 'calGain', 'calRed', 'calGreen', 'calBlue'];
              fields.forEach(field => {
                  const el = document.querySelector(`[name="${field}"]`);
                  if (el && l[field] !== undefined){
                    if (field == 'dataPin' || field == 'clockPin')
                    {
                        if (el.tagName === 'SELECT' && !(Array.from(el.options).some(opt => String(opt.value) === String(l[field])))) {
                            el.add(new Option(`GPIO ${l[field]}`, l[field]));
                        }
                    }
                    el.value = l[field];
                    el.dispatchEvent(new Event('input'));
                  }
              });

              if (l["apMode"] === true) {
                  document.getElementById("wifi_configuration_page").style.display = "block";
                  loadSubScript('wifi', "setupWifi");
              } else {
                  document.getElementById("ota_page").style.display = "block";           
              }

              if (typeof toggleCalibration === "function") {
                  toggleCalibration();
              }

              if (typeof setupPinValidator === "function") {
                  setupPinValidator();
              }
          }
          catch (e) {
              console.error("Config load failed:", e);
          }
      }

      document.addEventListener('DOMContentLoaded', () => {          
          loadCurrentConfig();
      });

      document.querySelector('form[action="/save_config"]').addEventListener('submit', async (e) => {
          e.preventDefault();
          const f = e.target, btn = f.querySelector('button');
          btn.setAttribute('aria-busy', 'true');

          try {
              const res = await fetch(f.action, { method: 'POST', body: new URLSearchParams(new FormData(f)) });
              if (res.ok) {
                  const data = await res.json();
                  showToast(data.status === 'reboot');
              }
          } catch (err) { alert("Error!"); }
          
          btn.setAttribute('aria-busy', 'false');
      });
</script>
</body>
</html>